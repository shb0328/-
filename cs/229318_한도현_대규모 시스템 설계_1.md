# 대규모 시스템 설계

###  api.mysite.com을 사용자 단말에서 입력 시 

-  #### 사용자단말 -> dns서버 -> IP address -> 웹서버 -> DB -> 웹서버 -> 사용자 단말



## 사용자가 늘어남에 따라 취할 수 있는 방법

1. ### 수직적 확장 (scale up) VS *<u>수평적 확장(scale out)</u>*

   - ##### 수직적 확장은 한계가 있다. 

   - ##### 시스템이 더 커질 가능성이 있을 경우

   - 한 서버에 문제가 있더라도 복구 => 가용성

   - 트래픽 분산 

   - 로드 밸런서 : 공개 주소와 비공개 주소(private address) 분리 

2. ### 데이터베이스 다중화

   - 주 데이터베이스와 부 데이터베이스 분리 
   - 주 데이터베이스 : 데이터 쓰기,변경,삭제
   - 부 데이터베이스 : 읽기 => 일반적으로 읽기가 빈번하므로 부 데이터베이스 수가 많아야 함
   - 주 데이터베이스가 다운된다면 부 데이터베이스 중 하나가 주 데이터베이스 역할

3. ### 캐시

   - 데이터베이스에 접근해서 데이터를 읽어들이는 일은 시간이 오래걸리는 작업
   - 1. 웹 서버 -> 캐시 -> 캐시에 없을 시 -> 데이터베이스 -> 캐시 -> 캐시에 저장 -> 웹 서버 응답
     2. 웹 서버 -> 캐시 -> 캐시 HIT -> 웹 서버 :  
   - 유의할 점 
     : 데이터 갱신이 자주 일어나면 일관성 문제 
     : 영속성 데이터는 하면 안됨 => 비휘봘성 메모리에 저장하므로
     : 캐시 데이터 만료 정책 
     : 장애 대응
     : 캐시 메모리 크기
     : 데이터 방출 정책 => 메모리가 가득 찼을 때 어떤 데이터를 내보낼 것인가 : LRU / LFU / FIFO

4. ### CDN(Content Delivery Network)

   - 정적 콘텐츠 캐싱 방식으로 사용자 단말에서 요청 시 정적 콘텐츠는 따로 CDN에 요청
     (정적 콘텐츠 : html, css, js, 이미지 등)
   - CDN에 없을 시 원본 서버에 요청

## 중간 점검

#### 사용자 단말 -> CDN(정적 콘텐츠) -> 그 외 로드밸런서(Public IP) -> 웹서버(서버1,서버2,...) -> 캐시 -> (주/부) 데이터베이스



5. ### Stateless 웹 계층

   - 웹 서버가 더 확장될 필요성이 있을 때
   - 사용자1이 웹서버1, 사용자2가 웹서버2, 사용자3가 웹서버3,...에 요청할 때, 각 서버가 상태를 가지면서 세션 데이터를 저장한다면 사용자1은 앞으로도 웹서버 1에 요청해야 일관성을 가진다
   - 모든 사용자의 요청을 하나의 웹서버에 요청하며 웹 서버는 공유 저장소에서 세션을 조회한다 공유 저장소는 Memcached / Redis같은 캐시 시스템이거나 NoSQL같은 데이터베이스 시스템
   - Stateless 웹 서버는 단순하고 강력하여 규모 확장이 유연할 수 있다

6. ### 데이터센터

   - 해외 서비스가 필요하게 될 경우 물리서버를 나눌 필요가 있다.(국내더라도 나눌 수도 있음)
   - GeoDNS

7. ### 메시지 큐

   - 작업 생산자와 작업 소비자를 분리하며 서로 직접 소통하지 않는다
   - 작업 생산자가 원할 때, 메시지 큐에 작업 내용을 밀어넣으면 소비자도 원할 때, 메시지 큐에서 작업을 꺼내와서 소비한다

8. ### 샤딩

   - 수평적 확장 방법으로서, 샤딩 키를 기준으로 여러 데이터베이스에 데이터를 균등하게 나누어 저장한다
   - 예) user_id % 4 연산 값이 0,1,2,3인 데이터를 서로 같은 데이터베이스에 저장한다.
   - 우연히 user_name이 유명인사가 몰린 데이터베이스 생성 시 트래픽이 한 서버에 몰릴 수 있으므로 조절할 필요가 있다
